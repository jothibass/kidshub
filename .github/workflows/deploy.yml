name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # 1) CHECKOUT REPO
      # -----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------
      # 2) SSH KEY SETUP
      # -----------------------------------------
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # -----------------------------------------
      # 3) DEPLOY BACKEND TO EC2
      # -----------------------------------------
      - name: Copy backend files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend/*"
          target: "/var/www/kidshub/backend"

      # -----------------------------------------
      # 4) DEPLOY FRONTEND BUILD (optional)
      # -----------------------------------------
      - name: Copy frontend dist to EC2
        if: ${{ hashFiles('frontend/dist/**') != '' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/var/www/kidshub/frontend/dist"

      # -----------------------------------------
      # 5) RESTART BACKEND ON EC2
      # -----------------------------------------
      - name: Restart PM2 backend
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /var/www/kidshub/backend
            npm install --omit=dev
            pm2 restart kidshub || pm2 start server.js --name kidshub
            pm2 save

      # -----------------------------------------
      # 6) RELOAD NGINX
      # -----------------------------------------
      - name: Reload nginx
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo nginx -t
            sudo systemctl restart nginx
