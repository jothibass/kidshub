name: Build & Deploy to EC2

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      # allow override via repository secrets if needed
      DEPLOY_DIR: deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # ----------------------------
      # Backend dependencies (safe fallback)
      # ----------------------------
      - name: Install backend dependencies (cache + fallback)
        working-directory: backend
        run: |
          echo "Working dir: $(pwd)"
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "Lockfile found — using npm ci"
            npm ci --omit=dev --no-audit --no-fund
          else
            echo "No lockfile — using npm install"
            npm install --omit=dev --no-audit --no-fund
          fi

      # ----------------------------
      # Frontend build (safe fallback)
      # ----------------------------
      - name: Build frontend
        working-directory: frontend
        run: |
          echo "Working dir: $(pwd)"
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "Lockfile found — using npm ci for frontend"
            npm ci
          else
            echo "No lockfile — using npm install for frontend"
            npm install
          fi
          npm run build

      # ----------------------------
      # Prepare deploy package
      # ----------------------------
      - name: Prepare deploy directory
        run: |
          rm -rf ${{ env.DEPLOY_DIR }} || true
          mkdir -p ${{ env.DEPLOY_DIR }}
          # copy backend
          if [ -d backend ]; then
            cp -r backend ${{ env.DEPLOY_DIR }}/backend
          fi
          # copy migrations if any
          mkdir -p ${{ env.DEPLOY_DIR }}/migrations
          if [ -d backend/migrations ]; then
            cp backend/migrations/* ${{ env.DEPLOY_DIR }}/migrations/ || true
          fi
          # include frontend build when present
          if [ -d frontend/dist ]; then
            mkdir -p ${{ env.DEPLOY_DIR }}/frontend
            cp -r frontend/dist ${{ env.DEPLOY_DIR }}/frontend/dist
          fi
          # include deploy script if present
          if [ -f deploy/deploy.sh ]; then
            mkdir -p ${{ env.DEPLOY_DIR }}/deploy
            cp deploy/deploy.sh ${{ env.DEPLOY_DIR }}/deploy/deploy.sh
          fi
          ls -la ${{ env.DEPLOY_DIR }}

      # ----------------------------
      # Add SSH key for the runner
      # ----------------------------
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # ----------------------------
      # Upload deploy folder to EC2
      # ----------------------------
      - name: Upload deploy folder to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy/*"
          target: "/home/ec2-user/deploy"

      # ----------------------------
      # Run deploy script on EC2
      # ----------------------------
      - name: Run deploy script on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            echo "Starting remote deploy on $(hostname) at $(date -u)"
            # Ensure deploy script is executable (if present)
            if [ -f /home/ec2-user/deploy/deploy/deploy.sh ]; then
              chmod +x /home/ec2-user/deploy/deploy/deploy.sh || true
              /home/ec2-user/deploy/deploy/deploy.sh
              exit $?
            fi

            # Support older path where deploy.sh was copied directly under /home/ec2-user/deploy
            if [ -f /home/ec2-user/deploy/deploy.sh ]; then
              chmod +x /home/ec2-user/deploy/deploy.sh || true
              /home/ec2-user/deploy/deploy.sh
              exit $?
            fi

            # Otherwise, do a safe fallback deploy steps inline
            echo "deploy.sh not found — falling back to inline deploy steps"
            set -x
            APP_ROOT="/var/www/kidshub"
            sudo mkdir -p "$APP_ROOT"
            # copy backend if present
            if [ -d /home/ec2-user/deploy/backend ]; then
              sudo rm -rf "${APP_ROOT}/backend.bak" || true
              sudo cp -a "${APP_ROOT}/backend" "${APP_ROOT}/backend.bak" || true
              sudo rm -rf "${APP_ROOT}/backend"
              sudo mkdir -p "${APP_ROOT}/backend"
              sudo cp -r /home/ec2-user/deploy/backend/* "${APP_ROOT}/backend/"
              sudo chown -R ec2-user:ec2-user "${APP_ROOT}/backend"
            fi

            # install backend deps if package.json exists
            if [ -f "${APP_ROOT}/backend/package.json" ]; then
              pushd "${APP_ROOT}/backend"
              if [ -f package-lock.json ]; then
                npm ci --omit=dev --no-audit --no-fund || npm install --omit=dev --no-audit --no-fund
              else
                npm install --omit=dev --no-audit --no-fund || true
              fi
              popd
            fi

            # run migrations if present and env provided (this relies on deploy.sh for richer handling)
            if [ -d /home/ec2-user/deploy/migrations ] && [ -n "${{ secrets.RDS_ENDPOINT || '' }}" ]; then
              echo "Migrations present — attempting to run (docker preferred)"
              if command -v docker >/dev/null 2>&1; then
                sudo docker run --rm -v /home/ec2-user/deploy/migrations:/work -e PGPASSWORD="${{ secrets.RDS_MASTER_PASS }}" postgres:15 bash -lc "\
                  for f in /work/*.sql; do \
                    echo '---- running' \$f; \
                    psql \"host=${{ secrets.RDS_ENDPOINT }} user=${{ secrets.RDS_MASTER_USER }} dbname=${{ secrets.DB_NAME }} sslmode=require\" -f \"\$f\" || exit 2; \
                  done"
              else
                echo "docker not available; skipping automated migrations in fallback"
              fi
            fi

            # deploy frontend if built
            if [ -d /home/ec2-user/deploy/frontend/dist ]; then
              sudo rm -rf /var/www/kidshub/dist || true
              sudo mkdir -p /var/www/kidshub/dist
              sudo cp -r /home/ec2-user/deploy/frontend/dist/* /var/www/kidshub/dist/
              sudo chown -R ec2-user:ec2-user /var/www/kidshub/dist
              sudo chmod -R a+rX /var/www/kidshub/dist
            fi

            # restart backend via pm2 if available
            if command -v pm2 >/dev/null 2>&1; then
              if pm2 list | grep -q kidshub; then
                pm2 restart kidshub || pm2 start /var/www/kidshub/backend/server.js --name kidshub || true
              else
                if [ -f /var/www/kidshub/backend/server.js ]; then
                  pm2 start /var/www/kidshub/backend/server.js --name kidshub || true
                fi
              fi
              pm2 save || true
            fi

            # test and reload nginx
            sudo nginx -t && sudo systemctl reload nginx || true

            echo "Fallback deploy completed"

