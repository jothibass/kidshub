name: Build & Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install frontend deps & build
        working-directory: frontend
        run: |
          echo ">>> Node version"
          node -v
          echo ">>> npm version"
          npm -v
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Show frontend/dist (debug)
        run: |
          echo "=== frontend root ==="
          ls -la frontend
          echo "=== frontend/dist ==="
          ls -la frontend/dist || true

      - name: Prepare deploy package
        run: |
          rm -rf deploy || true
          mkdir -p deploy
          cp -r backend deploy/backend || true
          if [ -d frontend/dist ]; then
            mkdir -p deploy/frontend
            cp -r frontend/dist deploy/frontend/dist
          fi
          mkdir -p deploy/migrations
          cp -r backend/migrations/* deploy/migrations/ 2>/dev/null || true
          cp -v deploy/deploy.sh deploy/deploy.sh || true

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Upload deploy folder to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy/*"
          target: "/home/ec2-user/deploy"

      - name: Run deploy script on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            chmod +x /home/ec2-user/deploy/deploy.sh || true
            export RDS_ENDPOINT="${{ secrets.RDS_ENDPOINT || '' }}"
            export RDS_MASTER_USER="${{ secrets.RDS_MASTER_USER || '' }}"
            export RDS_MASTER_PASS="${{ secrets.RDS_MASTER_PASS || '' }}"
            export DB_NAME="${{ secrets.DB_NAME || '' }}"
            bash /home/ec2-user/deploy/deploy.sh
