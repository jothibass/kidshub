name: "Build  Deploy to EC2"

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_DIR: deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug: workspace listing
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          pwd
          ls -la
          find . -maxdepth 3 -mindepth 1 -print | sed -n '1,200p'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Find backend path
        id: find-backend
        run: |
          set -euo pipefail
          BACKEND_PATH=""
          if [ -f "./backend/package.json" ]; then
            BACKEND_PATH="./backend"
          elif [ -f "./src/backend/package.json" ]; then
            BACKEND_PATH="./src/backend"
          else
            p=$(find . -maxdepth 4 -type f -path "*/backend/package.json" | head -n1 || true)
            if [ -n "$p" ]; then
              BACKEND_PATH="$(dirname "$p")"
            fi
          fi
          echo "backend_path=$BACKEND_PATH" >> "$GITHUB_OUTPUT"

      - name: Install backend deps (if any)
        if: steps.find-backend.outputs.backend_path != ''
        run: |
          set -euo pipefail
          echo "Backend dir: ${{ steps.find-backend.outputs.backend_path }}"
          cd "${{ steps.find-backend.outputs.backend_path }}"
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci --omit=dev --no-audit --no-fund
          else
            npm install --omit=dev --no-audit --no-fund
          fi

      - name: Find frontend path
        id: find-frontend
        run: |
          set -euo pipefail
          FRONTEND_PATH=""
          if [ -f "./frontend/package.json" ]; then
            FRONTEND_PATH="./frontend"
          elif [ -f "./web/package.json" ]; then
            FRONTEND_PATH="./web"
          else
            p=$(find . -maxdepth 4 -type f -path "*/frontend/package.json" | head -n1 || true)
            if [ -n "$p" ]; then
              FRONTEND_PATH="$(dirname "$p")"
            fi
          fi
          echo "frontend_path=$FRONTEND_PATH" >> "$GITHUB_OUTPUT"

      - name: Build frontend (if any)
        if: steps.find-frontend.outputs.frontend_path != ''
        run: |
          set -euo pipefail
          echo "Frontend dir: ${{ steps.find-frontend.outputs.frontend_path }}"
          cd "${{ steps.find-frontend.outputs.frontend_path }}"
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi
          npm run build

      - name: Prepare deploy package
        run: |
          set -euo pipefail
          rm -rf "${{ env.DEPLOY_DIR }}" || true
          mkdir -p "${{ env.DEPLOY_DIR }}"
          if [ -d ./backend ]; then
            cp -r backend "${{ env.DEPLOY_DIR }}/backend"
          fi
          if [ -n "${{ steps.find-backend.outputs.backend_path }}" ] && [ "${{ steps.find-backend.outputs.backend_path }}" != "./backend" ]; then
            mkdir -p "${{ env.DEPLOY_DIR }}/backend"
            cp -r "${{ steps.find-backend.outputs.backend_path }}"/* "${{ env.DEPLOY_DIR }}/backend/" || true
          fi
          mkdir -p "${{ env.DEPLOY_DIR }}/migrations"
          if [ -d backend/migrations ]; then
            cp backend/migrations/* "${{ env.DEPLOY_DIR }}/migrations/" || true
          fi
          if [ -d frontend/dist ]; then
            mkdir -p "${{ env.DEPLOY_DIR }}/frontend"
            cp -r frontend/dist "${{ env.DEPLOY_DIR }}/frontend/dist"
          fi
          if [ -n "${{ steps.find-frontend.outputs.frontend_path }}" ] && [ "${{ steps.find-frontend.outputs.frontend_path }}" != "./frontend" ] && [ -d "${{ steps.find-frontend.outputs.frontend_path }}/dist" ]; then
            mkdir -p "${{ env.DEPLOY_DIR }}/frontend"
            cp -r "${{ steps.find-frontend.outputs.frontend_path }}/dist" "${{ env.DEPLOY_DIR }}/frontend/dist" || true
          fi
          if [ -f deploy/deploy.sh ]; then
            mkdir -p "${{ env.DEPLOY_DIR }}/deploy"
            cp deploy/deploy.sh "${{ env.DEPLOY_DIR }}/deploy/deploy.sh"
          fi
          ls -la "${{ env.DEPLOY_DIR }}"

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Upload deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy/*"
          target: "/home/ec2-user/deploy"

      - name: Run deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            if [ -f /home/ec2-user/deploy/deploy/deploy.sh ]; then
              chmod +x /home/ec2-user/deploy/deploy/deploy.sh || true
              /home/ec2-user/deploy/deploy/deploy.sh
              exit $?
            fi
            if [ -f /home/ec2-user/deploy/deploy.sh ]; then
              chmod +x /home/ec2-user/deploy/deploy.sh || true
              /home/ec2-user/deploy/deploy.sh
              exit $?
            fi
            echo "No deploy.sh found; running fallback inline deploy"
            APP_ROOT="/var/www/kidshub"
            sudo mkdir -p "$APP_ROOT"
            if [ -d /home/ec2-user/deploy/backend ]; then
              sudo rm -rf "${APP_ROOT}/backend.bak" || true
              sudo cp -a "${APP_ROOT}/backend" "${APP_ROOT}/backend.bak" || true
              sudo rm -rf "${APP_ROOT}/backend"
              sudo mkdir -p "${APP_ROOT}/backend"
              sudo cp -r /home/ec2-user/deploy/backend/* "${APP_ROOT}/backend/"
              sudo chown -R ec2-user:ec2-user "${APP_ROOT}/backend"
            fi
            if [ -d /home/ec2-user/deploy/frontend/dist ]; then
              sudo rm -rf /var/www/kidshub/dist || true
              sudo mkdir -p /var/www/kidshub/dist
              sudo cp -r /home/ec2-user/deploy/frontend/dist/* /var/www/kidshub/dist/
              sudo chown -R ec2-user:ec2-user /var/www/kidshub/dist
              sudo chmod -R a+rX /var/www/kidshub/dist
            fi
            if command -v pm2 >/dev/null 2>&1; then
              if pm2 list | grep -q kidshub; then
                pm2 restart kidshub || pm2 start /var/www/kidshub/backend/server.js --name kidshub || true
              else
                if [ -f /var/www/kidshub/backend/server.js ]; then
                  pm2 start /var/www/kidshub/backend/server.js --name kidshub || true
                fi
              fi
              pm2 save || true
            fi
            sudo nginx -t && sudo systemctl reload nginx || true